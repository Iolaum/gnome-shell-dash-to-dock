From 6fe580562533d439039e1fa89994278d74d31267 Mon Sep 17 00:00:00 2001
From: =?UTF-8?q?Marco=20Trevisan=20=28Trevi=C3=B1o=29?= <mail@3v1n0.net>
Date: Sat, 14 Mar 2020 02:52:16 +0100
Subject: [PATCH 28/37] appIcons: Redirect events from the showAppIcon
 toggleButton to the parent

---
 appIcons.js | 31 ++++++++++++++++++++++++-------
 1 file changed, 24 insertions(+), 7 deletions(-)

diff --git a/appIcons.js b/appIcons.js
index 95ff0a5..378559d 100644
--- a/appIcons.js
+++ b/appIcons.js
@@ -784,6 +784,11 @@ const MyAppIconMenu = class DashToDock_MyAppIconMenu extends AppDisplay.AppIconM
     }
 
     _redisplay() {
+        // This will be removed by 3.36.1
+        return this._rebuildMenu();
+    }
+
+    _rebuildMenu() {
         this.removeAll();
 
         if (Docking.DockManager.settings.get_boolean('show-windows-preview')) {
@@ -881,7 +886,10 @@ const MyAppIconMenu = class DashToDock_MyAppIconMenu extends AppDisplay.AppIconM
             }
 
         } else {
-            super._redisplay();
+            if (super._rebuildMenu)
+                super._rebuildMenu();
+            else
+                super._redisplay();
         }
 
         // quit menu
@@ -1036,6 +1044,10 @@ var MyShowAppsIcon = GObject.registerClass({
         this.toggleButton.connect('clicked',
             this._removeMenuTimeout.bind(this));
 
+        this.reactive = true;
+        this.toggleButton.popupMenu = () => this.popupMenu.call(this);
+        this.toggleButton._removeMenuTimeout = () => this._removeMenuTimeout.call(this);
+
         this._menu = null;
         this._menuManager = new PopupMenu.PopupMenuManager(this);
         this._menuTimeoutId = 0;
@@ -1043,20 +1055,20 @@ var MyShowAppsIcon = GObject.registerClass({
 
     vfunc_leave_event(leaveEvent)
     {
-        return AppDisplay.AppIcon.prototype.vfunc_leave_event.apply(this,
-            leaveEvent);
+        return AppDisplay.AppIcon.prototype.vfunc_leave_event.call(
+            this.toggleButton, leaveEvent);
     }
 
     vfunc_button_press_event(buttonPressEvent)
     {
-        return AppDisplay.AppIcon.prototype.vfunc_button_press_event.apply(this,
-            buttonPressEvent);
+        return AppDisplay.AppIcon.prototype.vfunc_button_press_event.call(
+            this.toggleButton, buttonPressEvent);
     }
 
     vfunc_touch_event(touchEvent)
     {
-        return AppDisplay.AppIcon.prototype.vfunc_touch_event.apply(this,
-            touchEvent);
+        return AppDisplay.AppIcon.prototype.vfunc_touch_event.call(
+            this.toggleButton, touchEvent);
     }
 
     showLabel() {
@@ -1111,6 +1123,11 @@ var MyShowAppsIcon = GObject.registerClass({
  */
 var MyShowAppsIconMenu = class DashToDock_MyShowAppsIconMenu extends MyAppIconMenu {
     _redisplay() {
+        // This will be removed by 3.36.1
+        return this._rebuildMenu();
+    }
+
+    _rebuildMenu() {
         this.removeAll();
 
         /* Translators: %s is "Settings", which is automatically translated. You
-- 
2.26.0

